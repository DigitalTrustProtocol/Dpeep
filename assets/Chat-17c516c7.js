import{k as U,y as D,x as W,K as p,o as e,$ as j,M as X,S as y,t as x,N as q,R as Y,P as de,h as C,a as Z,_ as z,p as B,l as $,I as he,v as ue,b as fe,H as R,c as pe,d as me,E as Q,n as ee,g as ge,e as we,f as te,F as be,T as ye,i as ve,j as xe,m as Ne,C as G,Q as ke,q as Ce,r as V,s as Se,u as _e,A as Ae,w as $e,V as Ie,z as Ke,B as Ee}from"./index-88716094.js";function Me({title:t,titleId:l,...n},a){return D("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:1.5,stroke:"currentColor","aria-hidden":"true",ref:a,"aria-labelledby":l},n),t?D("title",{id:l},t):null,D("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M19.5 8.25l-7.5 7.5-7.5-7.5"}))}const Te=U(Me),He=Te;function Le({title:t,titleId:l,...n},a){return D("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor","aria-hidden":"true",ref:a,"aria-labelledby":l},n),t?D("title",{id:l},t):null,D("path",{fillRule:"evenodd",d:"M3 4.875C3 3.839 3.84 3 4.875 3h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013 9.375v-4.5zM4.875 4.5a.375.375 0 00-.375.375v4.5c0 .207.168.375.375.375h4.5a.375.375 0 00.375-.375v-4.5a.375.375 0 00-.375-.375h-4.5zm7.875.375c0-1.036.84-1.875 1.875-1.875h4.5C20.16 3 21 3.84 21 4.875v4.5c0 1.036-.84 1.875-1.875 1.875h-4.5a1.875 1.875 0 01-1.875-1.875v-4.5zm1.875-.375a.375.375 0 00-.375.375v4.5c0 .207.168.375.375.375h4.5a.375.375 0 00.375-.375v-4.5a.375.375 0 00-.375-.375h-4.5zM6 6.75A.75.75 0 016.75 6h.75a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75h-.75A.75.75 0 016 7.5v-.75zm9.75 0A.75.75 0 0116.5 6h.75a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-.75zM3 14.625c0-1.036.84-1.875 1.875-1.875h4.5c1.036 0 1.875.84 1.875 1.875v4.5c0 1.035-.84 1.875-1.875 1.875h-4.5A1.875 1.875 0 013 19.125v-4.5zm1.875-.375a.375.375 0 00-.375.375v4.5c0 .207.168.375.375.375h4.5a.375.375 0 00.375-.375v-4.5a.375.375 0 00-.375-.375h-4.5zm7.875-.75a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-.75zm6 0a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-.75zM6 16.5a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-.75zm9.75 0a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-.75zm-3 3a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-.75zm6 0a.75.75 0 01.75-.75h.75a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75h-.75a.75.75 0 01-.75-.75v-.75z",clipRule:"evenodd"}))}const Be=U(Le),De=Be,Pe=({chat:t,active:l=!1,latestMsg:n={},name:a})=>{const g=k=>{k.keyCode===13&&k.target.click()},h=p.toNostrBech32Address(t,"npub"),N=p.isMine(t);return e("div",{onKeyUp:g,role:"button",tabIndex:0,className:`p-2 ${l?"bg-neutral-800":"hover:bg-neutral-900"}`,onClick:()=>j(`/chat/${h||t}`),children:e("div",{className:"flex gap-4 overflow-x-hidden",children:[e(X,{str:h||t,width:49}),e("div",{className:"flex flex-col",children:[e("span",{className:"name",children:[e(y,{when:a,children:a}),e(y,{when:!a,children:[e(y,{when:N,children:e("span",{className:"font-bold italic",children:["📝 ",x("note_to_self")]})}),e(y,{when:!N,children:e(q,{pub:t})}),e(y,{when:n.created_at,children:e("small",{className:"ml-2 latest-time text-neutral-500",children:e(Y,{date:new Date(n.created_at*1e3)})})})]})]}),e("small",{className:"text-neutral-500 truncate",children:n.text})]})]})})},ze=W(Pe),Re=({active:t})=>e("div",{role:"button",tabIndex:0,className:`flex p-2 flex-row gap-4 h-16 items-center cursor-pointer hover:bg-neutral-900 ${t?"bg-neutral-700":""}`,onClick:()=>j("/chat/new"),children:[e("div",{className:"flex justify-center items-center w-12 h-12 rounded-full",children:e(de,{className:"w-6 h-6"})}),e("div",{className:"flex flex-row",children:e("div",{className:"flex flex-col",children:e("span",{className:"name",children:x("new_chat")})})})]}),je=(t,l)=>{const n=t[1].latest,a=l[1].latest;return n?a?a.created_at-n.created_at:-1:1},Oe=({activeChat:t,className:l})=>{const[n,a]=C(new Z([],je)),[g,h]=C(0),[N,k]=C(!1),K=z(null),E=()=>{Notification&&Notification.requestPermission().then(f=>{(f==="granted"||f==="denied")&&k(!1)})};B(()=>{const f=[],r=(S,u)=>{console.log("addToChats",u,S),a(i=>(i.set(u.split("/").pop(),{...S}),i)),h(i=>i+1)},m=p.getPubKey();return $.get("chats").get(m).put({id:m}),f.push($.get("chats").map(r,2)),f.push($.get("groups").map(r,2)),f.push($.get("scrollUp").on(()=>{window.scrollTo(0,0),K.current&&(K.current.scrollTop=0)})),()=>f.forEach(S=>S())},[]);const M=t&&p.toNostrHexAddress(t)||t;return e("section",{className:`md:border-r flex flex-shrink-0 border-neutral-800 overflow-x-hidden overflow-y-auto md:px-0 w-full md:w-64 ${l}`,ref:K,children:[e("div",{className:N?"":"hidden",onClick:E,children:[e("div",{className:"title",children:x("get_notified_new_messages")}),e("div",{children:e("a",{children:x("turn_on_desktop_notifications")})})]}),e("div",{className:"flex flex-1 flex-col overflow-y-auto",children:[e(Re,{active:M==="new"}),e(he,{children:Array.from(n.entries()).map(([f,r])=>e(ze,{active:f===M,chat:f,latestMsg:r==null?void 0:r.latest,name:r==null?void 0:r.name},f))})]})]})},se=({event:t,selfAuthored:l,showName:n})=>{const[a,g]=C(t.text||""),[h,N]=C(null),[k,K]=C(!1);B(()=>{let i=a;i?E(i):p.decryptMessage(t,T=>{i=T,E(i)})},[t.id,a]);const E=i=>{try{const T=i.slice(i.indexOf("{")),v=JSON.parse(T);if(ue(v)&&fe(v)&&(console.log(111,v.tags.length===1,v.tags[0][0]==="p",v.tags[0][1]===v.pubkey),v.tags.length===1&&v.tags[0][0]==="p"&&v.tags[0][1]===t.pubkey)){v.text=v.content,N(v);return}}catch{}K(!0),g(i)};if(h)return e(se,{event:h,showName:!0,selfAuthored:p.isMine(h.pubkey)});if(!k)return null;const M=()=>{j(`/${p.toNostrBech32Address(t.pubkey,"npub")}`)},f=a&&a.length===2&&R.isEmoji(a),r="",m=r.seen?"text-green-500":"text-neutral-500",S=r.delivered?"border-green-500":"border-neutral-500";return e("div",{className:`p-2 w-full md:w-2/3 rounded-xl mb-1 ${l?"self-end bg-iris-blue text-white":"self-start bg-neutral-700 text-white"} ${m} ${S} flex flex-col items-start`,children:e("div",{className:"w-full",children:[e("div",{className:"mb-2",children:n&&e("small",{onClick:M,className:"cursor-pointer text-xs",children:e(q,{pub:t.pubkey},t.pubkey)})}),e("div",{className:`preformatted-wrap text-base ${f?"text-4xl":""}`,children:e(pe,{event:t,children:a})}),e("div",{className:`${l?"text-right":"text-left"} text-xs text-white`,children:e(Y,{date:new Date(t.created_at*1e3)})})]})})},Fe=W(se),Ve=({activeChat:t,class:l,autofocus:n,onSubmit:a,keyPair:g})=>{const[h,N]=C(""),k=z(null);B(()=>{$.get("chats").get(t).get("draft").once(r=>{r&&N(r)})},[]),B(()=>{var r;!R.isMobile&&n!==!1&&((r=k.current)==null||r.focus())},[n]);const K=r=>{try{const m=p.toNostrHexAddress(t);if(!m)throw new Error("invalid public key "+m);return p.encrypt(r,m)}catch(m){console.error(m)}},E=async r=>{if(r.preventDefault(),!h.length)return;const m=4,S=Math.floor(Date.now()/1e3),u={kind:m,created_at:S};if(g){let i={kind:m,created_at:S,content:h,tags:[["p",g.pubKey]]};i=await Q.sign(i),u.content=await ee.encrypt(g.privKey,g.pubKey,`${h}

${JSON.stringify(i)}`),u.pubkey=g.pubKey,u.tags=[["p",g.pubKey]],console.log("event",u),u.id=ge(u),u.sig=we(u,g.privKey)}else{const i=p.toNostrHexAddress(t);if(u.content=await K(h),u.tags=[["p",i]],!i)throw new Error("invalid public key "+i)}Q.publish(u),N(""),$.get("chats").get(t).get("draft").put(""),a==null||a()},M=r=>{const m=r.target.value;N(m),$.get("chats").get(t).get("draft").put(m)},f=r=>{(r.metaKey||r.ctrlKey)&&r.key==="Enter"&&E(r)};return e("form",{autoComplete:"off",className:`flex flex-none flex-row gap-2 p-2 sticky w-full bottom-0 w-96 max-w-screen bg-black ${l||""}`,onSubmit:E,children:[e("input",{ref:k,className:"input input-sm flex-1 new-msg bg-neutral-700 text-white",onInput:M,onKeyDown:f,type:"text",placeholder:"Type a message",autoComplete:"off",autoCorrect:"off",autoCapitalize:"sentences",spellCheck:!0,value:h}),e("button",{className:`btn btn-sm ${h.length>0?"text-white bg-iris-blue":""}`,style:{marginRight:"0"},disabled:h.length===0,children:e(me,{width:"24"})})]})},J=te(()=>{const t=document.querySelector("#message-view");t&&t.scrollTo(0,t.scrollHeight-t.clientHeight)},100);function qe({id:t}){const l=z(null),n=z(new Z([],"created_at")),[a,g]=C([]),[h,N]=C(!0),[k,K]=C(""),[E,M]=C(!1),[f,r]=C(void 0),[m,S]=C(!1),u=be(()=>p.toNostrHexAddress(t)||t,[t]),i=[];let T;const v=()=>{const s=document.querySelectorAll(".day-separator");let o=s[s.length-1],d=o.getBoundingClientRect();for(;o&&d&&d.top-55>0;){for(o=o.previousElementSibling;o&&!o.classList.contains("day-separator");)o=o.previousElementSibling;d=o?o.getBoundingClientRect():null}if(!o)return;const w=o.cloneNode(!0),c=document.createElement("div");c.style.position="fixed",c.style.top="70px",c.style.textAlign="center",c.setAttribute("id","floating-day-separator"),c.style.width=l.current.offsetWidth+"px",c.appendChild(w);const _=document.getElementById("floating-day-separator");_&&_.remove(),setTimeout(()=>{w.style.opacity="0",w.style.transition="opacity 2s"},2e3),l.current.prepend(c)},ne=()=>{_e(u)},re=()=>{const s=l.current,o=s.scrollHeight-s.scrollTop<=s.offsetHeight+200,d=document.getElementById("scroll-down-btn");o?window.getComputedStyle(d).display!=="none"&&le(d,100):window.getComputedStyle(d).display==="none"&&oe(d,100)},le=(s,o)=>{let d=1;const w=setInterval(()=>{d<=.1&&(clearInterval(w),s.style.display="none"),s.style.opacity=d,s.style.filter="alpha(opacity="+d*100+")",d-=d*.1},o/10)},oe=(s,o)=>{let d=.1;s.style.display="block";const w=setInterval(()=>{d>=1&&clearInterval(w),s.style.opacity=d,s.style.filter="alpha(opacity="+d*100+")",d+=d*.1},o/10)},O=ye(()=>(f==null?void 0:f.privKey)&&p.toNostrBech32Address(f.privKey,"nsec")||"",[f]),ae=()=>{T=T||te(()=>{const s=document.getElementById("attachment-preview");s&&window.getComputedStyle(s).display!=="none"||(v(),re())},200),T()},F=()=>{const s=l.current;s==null||s.scrollTo({top:s.scrollHeight})},ce=()=>{let s;const o=p.getPubKey(),d=new Date,w=d.toLocaleDateString();let c,_;const A=[];return t&&t.length>4&&(a.forEach(b=>{if(!b)return null;const I=new Date(b.created_at*1e3);let H;if(I){const L=I.toLocaleDateString();if(L!==c){H=!0;const ie=R.getDaySeparatorText(I,L,d,w);A.push(e("div",{className:"px-2 mt-3 mb-4 py-1 inline-block day-separator bg-black opacity-50 text-white rounded-full",children:x(ie.toLowerCase())}))}c=L}let P=H;!H&&_&&b.pubkey!==_&&(A.push(e("div",{className:"m-2"})),P=!0),_=b.pubkey,A.push(e(Fe,{event:b,showName:P,selfAuthored:b.pubkey===o},`${b.created_at}${b.pubkey}`))}),s=e("div",{ref:l,className:"main-view p-2 overflow-y-auto overflow-x-hidden flex flex-col flex-grow h-full",onScroll:()=>ae(),children:[e("div",{className:"w-full flex flex-col items-center justify-end",children:[A,e("div",{className:"italic my-2 text-neutral-500 w-full text-center justify-self-center",children:[e(y,{when:m&&f,children:[e("div",{children:x("secret_chat_info")}),e("div",{className:"flex gap-2 flex-1 items-center justify-center mt-4",children:[e("button",{className:"btn btn-neutral btn-sm",onClick:()=>M(b=>!b),children:[e(De,{width:"20"}),x("show_qr_code")]}),e(G,{className:"btn btn-neutral btn-sm",copyStr:O(),text:"Copy nsec"}),e(G,{className:"btn btn-neutral btn-sm",copyStr:R.buildURL("chat",void 0,O()),text:x("copy_link")})]}),e(y,{when:E,children:e("div",{className:"mt-4",children:e(ke,{data:"nostr:"+O()})})})]}),e(y,{when:!m&&p.toNostrHexAddress(t)!==o,children:[e("div",{children:x("dm_privacy_warning")}),e("div",{className:"mt-4 flex gap-2 justify-center",children:[e(y,{when:k,children:e("button",{className:"btn btn-neutral btn-sm",onClick:()=>Ce(k),children:"Go to secret chat"})}),e(y,{when:!k,children:e("button",{className:"btn btn-neutral btn-sm",onClick:ne,children:"Invite to secret chat"})})]})]})]})]}),e("div",{id:"attachment-preview",className:"attachment-preview",style:{display:"none"}})]})),s};return ve(()=>{const s=l.current;if(s){const o=new ResizeObserver(()=>{F()});return o.observe(s),()=>{o.disconnect()}}}),B(()=>{const s=c=>{const _=A=>{n.current.set(A.id,A),g(Array.from(n.current.values()))};i.push(V.subscribe({kinds:[4],"#p":[p.getPubKey()],authors:[c]},_)),p.isMine(c)||i.push(V.subscribe({kinds:[4],"#p":[c],authors:[p.getPubKey()]},_))};$.get("chatInvites").get(u).once(c=>{c!=null&&c.priv&&K(c.priv)},!1,1);const o=()=>{const c=$.get("groups").get(t);c.on(_=>{const A=_.key,b=Se(A);r({privKey:A,pubKey:b}),i.push(V.subscribe({kinds:[4],"#p":[b],authors:[b]},async I=>{const H=await ee.decrypt(A,b,I.content);n.current.set(I.id,{...I,text:H}),g(Array.from(n.current.values()));const P=c.get("latest"),L=await P.once(void 0,!1,1);(!L||!L.created_at||L.created_at<I.created_at)&&P.put({id:I.id,created_at:I.created_at,text:H.slice(0,H.indexOf("{"))})}))},!1,1)};p.toNostrHexAddress(u)?s(u):(S(!0),o());const d=()=>{const c=w.scrollTop+w.clientHeight>=w.scrollHeight;h&&!c?N(!1):!h&&c&&N(!0)},w=l.current;return w&&w.addEventListener("scroll",d),()=>{l.current.removeEventListener("scroll",d),i.forEach(c=>c())}},[t]),B(()=>{h&&J(),document.querySelectorAll(".msg-content img").forEach(o=>{o.removeEventListener("load",s),o.addEventListener("load",s)});const s=()=>{h&&J()}},[h]),e(Ne,{children:[e(xe,{children:e("title",{children:x("messages")})}),e("div",{className:`${u?"":"hidden"} flex flex-1 flex-col`,children:[ce(),e(y,{when:u&&u.length>4,children:[e("div",{className:"relative",children:e("div",{id:"scroll-down-btn",style:{display:"none"},className:"absolute bottom-1 left-2 p-1.5 rounded-3xl bg-neutral-900 opacity-85 hover:cursor-pointer",onClick:()=>F(),children:e(He,{width:"24"})})}),e(Ve,{activeChat:u,onSubmit:()=>F(),keyPair:f},u)]})]})]})}const Qe=({activeChat:t})=>{const l=()=>{window.history.back()},n=()=>{window.scrollTo(0,0),t&&t.length>15&&j("/"+p.toNostrBech32Address(t,"npub"))},a=()=>e("div",{className:"flex gap-2",children:[e("button",{className:"btn btn-sm btn-primary",onClick:()=>$.get("showLoginModal").put(!0),children:x("log_in")}),e("button",{className:"btn btn-sm btn-neutral",onClick:()=>$.get("showLoginModal").put(!0),children:x("sign_up")})]}),h=!!p.getPubKey();return e("div",{className:"sticky top-0 z-10 cursor-pointer flex flex-wrap",onClick:n,children:e("div",{className:"w-full overflow-x-hidden bg-black md:bg-opacity-50 md:shadow-lg md:backdrop-blur-lg px-2",children:e("div",{className:"flex items-center justify-between h-12",children:[e(Ae,{width:24,onClick:l}),e(y,{when:t,children:e("div",{className:"flex flex-row gap-2 items-center",children:[e(X,{width:30,str:t}),e(q,{pub:t})]})}),e(y,{when:!t,children:e("div",{className:"flex flex-row gap-2 items-center",children:x("chat")})}),e(y,{when:h,children:e("div",{})}),e(y,{when:!h,children:a()})]})})})},Je=({id:t})=>{B(()=>{const n=window.location.hash.substr(1);n&&n.startsWith("nsec")&&(window.history.replaceState({},document.title,window.location.pathname),p.getPubKey()||p.loginAsNewUser(),$e(n))},[]);const l=n=>n==="new"?e(Ke,{}):n?e(qe,{id:n},n):e("div",{className:"hidden md:flex flex-col items-center justify-center flex-1",children:[e("div",{className:"my-4",children:e(Ee,{className:"w-24 h-24 text-neutral-400"})}),e("div",{className:"text-neutral-400",children:x("dm_privacy_warning")})]});return e(Ie,{hideHeader:!0,hideSideBar:!0,children:e("div",{className:"flex flex-col h-full max-h-screen",children:[e(Qe,{activeChat:t},t),e("div",{className:"flex flex-row flex-grow overflow-hidden",children:[e("div",{className:`flex-shrink-0 ${t?"hidden md:flex overflow-y-auto":"flex overflow-y-auto"}`,children:e(Oe,{activeChat:t,className:t?"hidden md:flex":"flex"})}),e("div",{className:`flex-grow overflow-y-auto ${t?"flex":"hidden md:flex"}`,children:l(t)},`chat-content-${t}`)]})]})})};export{Je as default};
